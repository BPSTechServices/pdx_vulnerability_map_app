library(shiny)
library(tidyverse)
library(leaflet)
library(RColorBrewer)
library(sf)
library(rlang)
library(scales)
library(shinythemes)
library(rio)
library(shinyBS)

#### Utility functions ####
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
TARGET_EPSG <- 2913

# setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

vulnerability_data <- readRDS("acs_vuln_weighting_data.rds") %>%
  mutate(NAME = substr(GEOID, 6, 11) %>% as.numeric(),
         NAME = paste0(NAME / 100, ", ", county))

hatch_people_of_color <- readRDS("hatch_people_of_color.rds")
hatch_households_with_limited_english <- readRDS("hatch_households_with_limited_english.rds")
hatch_persons_with_disabilities <- readRDS("hatch_persons_with_disabilities.rds")
hatch_retirees_65 <- readRDS("hatch_retirees_65.rds")
hatch_youth_0_21 <- readRDS("hatch_youth_0_21.rds")
hatch_vulnerable <- readRDS("hatch_vulnerable.rds")

base_data_labels <- rio::import("base_data_download_labels.xlsx")

usb <- readRDS("primary_place_outline.rds")

ui <- 
  fluidPage(
    theme = shinytheme("lumen"), ##(lumen, paper, simplex, flatly, yeti) ## See interactive themes: https://gallery.shinyapps.io/117-shinythemes/
    div(# Main Panel
      titlePanel(title = "Portland Vulnerability Weighting Tool"),
      style = "flex-grow:1; resize:horizontal; overflow: hidden; position:relative; margin-right: 310px ",
      tags$style(type = "text/css", "#vulnerabilitymap {height: calc(90vh) !important;}"),
      leafletOutput("vulnerabilitymap")
    ),
    wellPanel( # Sidebar
      style = "overflow-y: auto; position:fixed; width:300px; top:0; bottom:0;; right:0",
      shiny::helpText("Explore the demographic variables that go into calculating",
                      "an economic vulnerability index."),
      radioButtons(inputId = "geo_filter", label = "Filter for Region or Place:", choices = c("Portland Region" = "Region", "City of Portland" = "Primary Place"), selected = "Primary Place"),
      # bsButton(inputId = "geo_filter_button", label = "?", style = "info", 
      #          size = "extra-small", type = "action"),
      bsTooltip("geo_filter", "Select the extent of the mapping results: Census tracts within the 7-county Portland region, or tracts within the City of Portland</br>NOTE: The the extent of your selection influences the outcome of the mapping results, as each tract is compared to the entire selection.",
                placement = "bottom", trigger = "hover", options = list(container = "body")),             
      radioButtons(inputId = "calc_method", label = "Weighting Method:", choices = c("Percentile Rank" = "Percentile", "Z-Score" = "Z-Score"), selected = "Percentile"),
      bsTooltip("calc_method", "Percentile rank sums together the raw rank of the variables (e.g., a tract with 80% renters might rank in the 90th percentile).<br>The Z-score method sums together the number of standard deviations a tract is above or below the average (e.g., 80% renters might be 1.8 standard deviations above the mean).",
                placement = "bottom", trigger = "hover", options = list(container = "body")), 
      # sliderInput("z_tolerance", "Z-Tolerance Bottom Code:", min = 2, max = 7, value = 3),
      hr(),
      shiny::helpText("Slide bar to desired weight for each variable",
                      "you wish to add to the vulnerability model.",
                      "The weight corresponds to the relative importance",
                      "of that variable. 5 = very important, 0 = turned off.",
                      "Download the results using button at bottom."),
      mainPanel(),
      
      sliderInput("wt_people_of_color", "RACE: People of color", min = 0, max = 5, value = 1),
      sliderInput("wt_black_native_american", "RACE: Black+Indigenous people", min = 0, max = 5, value = 1),
      sliderInput("wt_adults_without_4_yr_degree", "EDUCATION: Adults w/o 4-yr degree", min = 0, max = 5, value = 1),
      sliderInput("wt_adjusted_household_income", "INCOME: Adjusted household income", min = 0, max = 5, value = 1),
      sliderInput("wt_housing_cost_burdened", "HOUSING: Housing cost burden >30%", min = 0, max = 5, value = 1),
      
      hr(),
      
      sliderInput("wt_households_with_limited_english", "LEP: Limited English-proficienct households", min = 0, max = 5, value = 0),
      sliderInput("wt_persons_with_disabilities", "DISABILITY: Persons w disabilities", min = 0, max = 5, value = 0),
      sliderInput("wt_commuters", "WORK: Commuters", min = 0, max = 5, value = 0),
      sliderInput("wt_unemployed_persons", "WORK: Unemployed persons", min = 0, max = 5, value = 0),
      sliderInput("wt_insufficient_commuter_vehicles", "WORK: Insufficient commuter vehicles", min = 0, max = 5, value = 0),
      sliderInput("wt_households_without_a_vehicle", "ACCESS: Households without a vehicle", min = 0, max = 5, value = 0),
      sliderInput("wt_no_computer_access", "ACCESS: No computer access", min = 0, max = 5, value = 0),
      sliderInput("wt_no_broadband_access", "ACCESS: No broadband access", min = 0, max = 5, value = 0),
      sliderInput("wt_students_k_12", "AGE: Students (K-12)", min = 0, max = 5, value = 0),
      sliderInput("wt_youth_0_21", "AGE: Youth (0-21)", min = 0, max = 5, value = 0),
      sliderInput("wt_retirees_65", "AGE: Retirees (65+)", min = 0, max = 5, value = 0),
      sliderInput("wt_median_household_income", "INCOME: Median household income", min = 0, max = 5, value = 0),
      sliderInput("wt_people_below_1_0_poverty", "INCOME: People below 1x poverty", min = 0, max = 5, value = 0),
      sliderInput("wt_people_below_2_0_poverty", "INCOME: People below 2x poverty", min = 0, max = 5, value = 0),
      sliderInput("wt_food_stamps_recipients", "HOUSEHOLDS: Food stamps recipients", min = 0, max = 5, value = 0),
      sliderInput("wt_renter_households", "HOUSEHOLDS: Renter households", min = 0, max = 5, value = 0),
      sliderInput("wt_cost_burdened_renters_35_percent", "HOUSEHOLDS: Renters paying 35%+ on rent", min = 0, max = 5, value = 0),
      sliderInput("wt_cost_burdened_owners_with_mortgage_35_percent", "HOUSEHOLDS: Owners paying 35%+ on mortgage", min = 0, max = 5, value = 0),
      sliderInput("wt_overcrowded_households", "HOUSEHOLDS: Overcrowded households", min = 0, max = 5, value = 0),

      
      actionButton("tabBut", label = "View Table"),
      br(),
      downloadButton("download_geojson", label = "Download Weighted Results"),
      br(),
      downloadButton("download_basedata", label = "Download Base Data"),
      hr(),
      div("View code on ", tags$a(href="https://github.com/BPSTechServices/pdx_vulnerability_map_app","GitHub."))
    ),
    bsModal(id = "modalTable", title = "Data Table", trigger = "tabBut", 
            size = "large",
            dataTableOutput("resultsTable"))
  )





##### Begin server #####
server <- function(input, output, session) {
  
  filtered_vulnerability_data <- reactive({
    if(input$geo_filter == "Primary Place"){
      vulnerability_data <- vulnerability_data %>%
        filter(in_primary_place == TRUE)
    }
    
    filtered_data <- vulnerability_data %>%
      mutate(across(.cols = c(people_of_color:youth_and_retirees), 
                    .fns = list(rnk = ~cume_dist(.),
                                z = ~scale(.))),
             across(ends_with("_z"), ~ case_when(. > 3 ~ 3,
                                                 . < -3 ~ -3,
                                                 T ~ .)),
             median_household_income_rnk = 1 - median_household_income_rnk,
             median_household_income_z = -median_household_income_z,
             adjusted_household_income_rnk = 1 - adjusted_household_income_rnk,
             adjusted_household_income_z = -median_household_income_z,
             per_capita_income_rnk = 1 - per_capita_income_rnk,
             per_capita_income_z = -per_capita_income_z)
    
    filtered_data
  })
  
  reweighted <- reactive({
    
    if(input$calc_method == "Z-Score"){
      reweighted_data <- filtered_vulnerability_data() %>%
        mutate(
          weighted_people_of_color = people_of_color_z * input$wt_people_of_color,
          weighted_black_native_american = black_native_american_z * input$wt_black_native_american,
          weighted_adults_without_4_yr_degree = adults_without_4_yr_degree_z * input$wt_adults_without_4_yr_degree,
          weighted_adjusted_household_income = adjusted_household_income_z * input$wt_adjusted_household_income,
          weighted_housing_cost_burdened = housing_cost_burdened_z * input$wt_housing_cost_burdened,
          weighted_households_with_limited_english = households_with_limited_english_z * input$wt_households_with_limited_english,
          weighted_persons_with_disabilities = persons_with_disabilities_z * input$wt_persons_with_disabilities,
          weighted_commuters = commuters_z * input$wt_commuters,
          weighted_unemployed_persons = unemployed_persons_z * input$wt_unemployed_persons,
          weighted_insufficient_commuter_vehicles = insufficient_commuter_vehicles_z * input$wt_insufficient_commuter_vehicles,
          weighted_households_without_a_vehicle = households_without_a_vehicle_z * input$wt_households_without_a_vehicle,
          weighted_no_computer_access = no_computer_access_z * input$wt_no_computer_access,
          weighted_no_broadband_access = no_broadband_access_z * input$wt_no_broadband_access,
          weighted_students_k_12 = students_k_12_z * input$wt_students_k_12,
          weighted_youth_0_21 = youth_0_21_z * input$wt_youth_0_21,
          weighted_retirees_65 = retirees_65_z * input$wt_retirees_65,
          weighted_median_household_income = median_household_income_z * input$wt_median_household_income,
          weighted_people_below_1_0_poverty = people_below_1_0_poverty_z * input$wt_people_below_1_0_poverty,
          weighted_people_below_2_0_poverty = people_below_2_0_poverty_z * input$wt_people_below_2_0_poverty,
          weighted_food_stamps_recipients = food_stamps_recipients_z * input$wt_food_stamps_recipients,
          weighted_renter_households = renter_households_z * input$wt_renter_households,
          weighted_cost_burdened_renters_35_percent = cost_burdened_renters_35_percent_z * input$wt_cost_burdened_renters_35_percent,
          weighted_cost_burdened_owners_with_mortgage_35_percent = cost_burdened_owners_with_mortgage_35_percent_z * input$wt_cost_burdened_owners_with_mortgage_35_percent,
          weighted_overcrowded_households = overcrowded_households_z * input$wt_overcrowded_households,
          
          composite_score = weighted_people_of_color + weighted_black_native_american + 
            weighted_adults_without_4_yr_degree + weighted_adjusted_household_income + 
            weighted_housing_cost_burdened + weighted_households_with_limited_english + 
            weighted_persons_with_disabilities + weighted_commuters + 
            weighted_unemployed_persons + weighted_insufficient_commuter_vehicles + 
            weighted_households_without_a_vehicle + weighted_no_computer_access + 
            weighted_no_broadband_access + weighted_students_k_12 + weighted_youth_0_21 + 
            weighted_retirees_65 + weighted_median_household_income + 
            weighted_people_below_1_0_poverty + weighted_people_below_2_0_poverty + 
            weighted_food_stamps_recipients + weighted_renter_households + 
            weighted_cost_burdened_renters_35_percent + 
            weighted_cost_burdened_owners_with_mortgage_35_percent + 
            weighted_overcrowded_households,# + weighted_user_data,
          
          indexed_score = round(range01(composite_score, na.rm = T) * 100, 0)
        ) %>%
        arrange(desc(indexed_score)) 
    }
    
    if(input$calc_method == "Percentile"){
      reweighted_data <- filtered_vulnerability_data() %>%
        mutate(
          weighted_people_of_color = people_of_color_rnk * input$wt_people_of_color,
          weighted_black_native_american = black_native_american_rnk * input$wt_black_native_american,
          weighted_adults_without_4_yr_degree = adults_without_4_yr_degree_rnk * input$wt_adults_without_4_yr_degree,
          weighted_adjusted_household_income = adjusted_household_income_rnk * input$wt_adjusted_household_income,
          weighted_housing_cost_burdened = housing_cost_burdened_rnk * input$wt_housing_cost_burdened,
          weighted_households_with_limited_english = households_with_limited_english_rnk * input$wt_households_with_limited_english,
          weighted_persons_with_disabilities = persons_with_disabilities_rnk * input$wt_persons_with_disabilities,
          weighted_commuters = commuters_rnk * input$wt_commuters,
          weighted_unemployed_persons = unemployed_persons_rnk * input$wt_unemployed_persons,
          weighted_insufficient_commuter_vehicles = insufficient_commuter_vehicles_rnk * input$wt_insufficient_commuter_vehicles,
          weighted_households_without_a_vehicle = households_without_a_vehicle_rnk * input$wt_households_without_a_vehicle,
          weighted_no_computer_access = no_computer_access_rnk * input$wt_no_computer_access,
          weighted_no_broadband_access = no_broadband_access_rnk * input$wt_no_broadband_access,
          weighted_students_k_12 = students_k_12_rnk * input$wt_students_k_12,
          weighted_youth_0_21 = youth_0_21_rnk * input$wt_youth_0_21,
          weighted_retirees_65 = retirees_65_rnk * input$wt_retirees_65,
          weighted_median_household_income = median_household_income_rnk * input$wt_median_household_income,
          weighted_people_below_1_0_poverty = people_below_1_0_poverty_rnk * input$wt_people_below_1_0_poverty,
          weighted_people_below_2_0_poverty = people_below_2_0_poverty_rnk * input$wt_people_below_2_0_poverty,
          weighted_food_stamps_recipients = food_stamps_recipients_rnk * input$wt_food_stamps_recipients,
          weighted_renter_households = renter_households_rnk * input$wt_renter_households,
          weighted_cost_burdened_renters_35_percent = cost_burdened_renters_35_percent_rnk * input$wt_cost_burdened_renters_35_percent,
          weighted_cost_burdened_owners_with_mortgage_35_percent = cost_burdened_owners_with_mortgage_35_percent_rnk * input$wt_cost_burdened_owners_with_mortgage_35_percent,
          weighted_overcrowded_households = overcrowded_households_rnk * input$wt_overcrowded_households,
          
          composite_score = weighted_people_of_color + weighted_black_native_american + 
            weighted_adults_without_4_yr_degree + weighted_adjusted_household_income + 
            weighted_housing_cost_burdened + weighted_households_with_limited_english + 
            weighted_persons_with_disabilities + weighted_commuters + 
            weighted_unemployed_persons + weighted_insufficient_commuter_vehicles + 
            weighted_households_without_a_vehicle + weighted_no_computer_access + 
            weighted_no_broadband_access + weighted_students_k_12 + weighted_youth_0_21 + 
            weighted_retirees_65 + weighted_median_household_income + 
            weighted_people_below_1_0_poverty + weighted_people_below_2_0_poverty + 
            weighted_food_stamps_recipients + weighted_renter_households + 
            weighted_cost_burdened_renters_35_percent + 
            weighted_cost_burdened_owners_with_mortgage_35_percent + 
            weighted_overcrowded_households,# + weighted_user_data,
          
          indexed_score = round(range01(composite_score, na.rm = T) * 100, 0)) %>%
        arrange(desc(indexed_score))
    }
    reweighted_data
  })
  
  output$download_geojson <- downloadHandler(
    filename = "custom_weight_export-geojson.geojson",
    content = function(file) {
      sf::st_write(obj = reweighted() %>% st_transform(TARGET_EPSG), dsn = file)
    }
  )  
  
  output$download_basedata <- downloadHandler(
    filename = "base_demographic_data.xlsx",
    content = function(file) {
      datalist <- list("data" = st_drop_geometry(filtered_vulnerability_data()), "labels" = base_data_labels)
      rio::export(datalist, file = file)
    }
  )
  
  
  
  bins <- c(0, 20, 40, 60, 80, 100)
  pal <- leaflet::colorBin(viridis_pal(option = "C")(length(bins)), bins = bins)
  
  output$vulnerabilitymap <- renderLeaflet({
    leaflet() %>%
      addProviderTiles('CartoDB.Positron') %>%
      setView(lng = -122.65, lat = 45.52, zoom = 11) %>% 
      addLegend("topright", pal = pal,
                values = bins,
                title = "Vulnerability Index",
                opacity = 0.6) %>%
      
      addPolylines(
        data = usb,
        weight = 2,
        opacity = 0.5,
        fillOpacity = 0,
        color = "#FF0000",
        group = "USB Overlay") %>%
      
      addPolylines(
        data = hatch_vulnerable,
        color = "black",
        weight = 0.6, 
        group = "Vulnerability Overlay"
      ) %>%
 
      addPolylines(
        data = hatch_people_of_color,
        color = "black",
        weight = 0.6, 
        group = "BIPOC Overlay"
      ) %>%
      
      addPolylines(
        data = hatch_households_with_limited_english,
        color = "black",
        weight = 0.6, 
        group = "LEP Overlay"
      ) %>%
      addPolylines(
        data = hatch_persons_with_disabilities,
        color = "black",
        weight = 0.6, 
        group = "Disability Overlay"
      ) %>%
      addPolylines(
        data = hatch_retirees_65,
        color = "black",
        weight = 0.6, 
        group = "Retiree (65+) Overlay"
      ) %>%
      addPolylines(
        data = hatch_youth_0_21,
        color = "black",
        weight = 0.6, 
        group = "Youth (0-21) Overlay"
      ) %>%
      ## Toggle group layers: https://rstudio.github.io/leaflet/showhide.html
      addLayersControl(
        overlayGroups = c("USB Overlay", "Vulnerability Overlay", "BIPOC Overlay", 
                          "LEP Overlay", "Disability Overlay", "Retiree (65+) Overlay",
                          "Youth (0-21) Overlay"),
        options = layersControlOptions(collapsed = FALSE)
      ) %>%
      hideGroup(c("Vulnerability Overlay", "BIPOC Overlay", 
                  "LEP Overlay", "Disability Overlay", "Retiree (65+) Overlay",
                  "Youth (0-21) Overlay"))
  })
  
  ## https://stackoverflow.com/questions/46186014/changing-leaflet-map-according-to-input-without-redrawing-multiple-polygons
  observe({
    popup_context <- paste0("<strong>Tract: </strong>", reweighted()$NAME,
                            "<br/><strong>Vulnerability score: </strong>", scales::comma(reweighted()$indexed_score, accuracy = 1),
                            "<br/><strong>People of color: </strong>", scales::percent(reweighted()$people_of_color, accuracy = 0.1),
                            "<br/><strong>Black + Indigenous: </strong>", scales::percent(reweighted()$black_native_american, accuracy = 0.1),
                            "<br/><strong>Adults without 4-yr degree: </strong>", scales::percent(reweighted()$adults_without_4_yr_degree, accuracy = 0.1),
                            "<br/><strong>Adjusted household income: </strong>", scales::dollar(reweighted()$adjusted_household_income, accuracy = 1),
                            "<br/><strong>Housing cost burdened: </strong>", scales::percent(reweighted()$housing_cost_burdened , accuracy = 0.1),
                            "<br/><strong>Households with limited English: </strong>", scales::percent(reweighted()$households_with_limited_english, accuracy = 0.1),
                            "<br/><strong>Persons with disabilities: </strong>", scales::percent(reweighted()$persons_with_disabilities, accuracy = 0.1),
                            "<br/><strong>Commuters: </strong>", scales::percent(reweighted()$commuters, accuracy = 0.1),
                            "<br/><strong>Unemployed persons: </strong>", scales::percent(reweighted()$unemployed_persons, accuracy = 0.1),
                            "<br/><strong>Insufficient commuter vehicles: </strong>", scales::percent(reweighted()$insufficient_commuter_vehicles, accuracy = 0.1),
                            "<br/><strong>Households without a vehicle: </strong>", scales::percent(reweighted()$households_without_a_vehicle , accuracy = 0.1),
                            "<br/><strong>No computer access: </strong>", scales::percent(reweighted()$no_computer_access, accuracy = 0.1),
                            "<br/><strong>No broadband access: </strong>", scales::percent(reweighted()$no_broadband_access, accuracy = 0.1),
                            "<br/><strong>Students (K-12): </strong>", scales::percent(reweighted()$students_k_12, accuracy = 0.1),
                            "<br/><strong>Youth (0-21): </strong>", scales::percent(reweighted()$youth_0_21, accuracy = 0.1),
                            "<br/><strong>Retirees (65+): </strong>", scales::percent(reweighted()$retirees_65, accuracy = 0.1),
                            "<br/><strong>Median household income: </strong>", scales::dollar(reweighted()$median_household_income, accuracy = 1),
                            "<br/><strong>People below 1x poverty: </strong>", scales::percent(reweighted()$people_below_1_0_poverty , accuracy = 0.1),
                            "<br/><strong>People below 2x poverty: </strong>", scales::percent(reweighted()$people_below_2_0_poverty , accuracy = 0.1),
                            "<br/><strong>Food stamp recipients: </strong>", scales::percent(reweighted()$food_stamps_recipients, accuracy = 0.1),
                            "<br/><strong>Renter households: </strong>", scales::percent(reweighted()$renter_households, accuracy = 0.1),
                            "<br/><strong>Cost-burdened renters: </strong>", scales::percent(reweighted()$cost_burdened_renters_35_percent, accuracy = 0.1),
                            "<br/><strong>Cost-burdened w mortgage: </strong>", scales::percent(reweighted()$cost_burdened_owners_with_mortgage_35_percent, accuracy = 0.1),
                            "<br/><strong>Overcrowded households: </strong>", scales::percent(reweighted()$overcrowded_households, accuracy = 0.1)
                            )
    
    proxy <- leafletProxy("vulnerabilitymap", data = reweighted())
    
    proxy %>% clearShapes() %>%
      addPolygons(
        fillColor = ~pal(indexed_score),
        weight = 1,
        opacity = 1,
        color = "white",
        dashArray = "3",
        popup = popup_context,
        fillOpacity = 0.5) %>%
      addPolylines(
        data = usb,
        weight = 2,
        opacity = 0.5,
        fillOpacity = 0,
        color = "#FF0000",
        group = "USB Overlay") %>%
      
      addPolylines(
        data = hatch_vulnerable,
        color = "black",
        weight = 0.6, 
        group = "Vulnerability Overlay"
      ) %>%
      
      addPolylines(
        data = hatch_people_of_color,
        color = "black",
        weight = 0.6, 
        group = "BIPOC Overlay"
      ) %>%
      
      addPolylines(
        data = hatch_households_with_limited_english,
        color = "black",
        weight = 0.6, 
        group = "LEP Overlay"
      ) %>%
      addPolylines(
        data = hatch_persons_with_disabilities,
        color = "black",
        weight = 0.6, 
        group = "Disability Overlay"
      ) %>%
      addPolylines(
        data = hatch_retirees_65,
        color = "black",
        weight = 0.6, 
        group = "Retiree (65+) Overlay"
      ) %>%
      addPolylines(
        data = hatch_youth_0_21,
        color = "black",
        weight = 0.6, 
        group = "Youth (0-21) Overlay"
      ) %>%
      ## Toggle group layers: https://rstudio.github.io/leaflet/showhide.html
      addLayersControl(
        overlayGroups = c("USB Overlay", "Vulnerability Overlay", "BIPOC Overlay", 
                          "LEP Overlay", "Disability Overlay", "Retiree (65+) Overlay",
                          "Youth (0-21) Overlay"),
        options = layersControlOptions(collapsed = TRUE)
      ) 
  })
  
  
  
  output$resultsTable <- renderDataTable({
    
    reweighted() %>%
      arrange(desc(indexed_score)) %>%
      st_drop_geometry() %>%
      select(GEOID,
             `Vulnerability Score` = indexed_score,
             `Adj. HH Income` = adjusted_household_income ,
             `Avg. HH Size` = average_household_size ,
             `Med. HH Income` = median_household_income ,
             `% POC` = people_of_color ,
             `% Black + Indigenous` = black_native_american ,
             `% < 4yr Deg.` = adults_without_4_yr_degree ,
             `% Cost Burdened HH` = housing_cost_burdened ,
             `% LEP HH` = households_with_limited_english ,
             `% Disability` = persons_with_disabilities ,
             `% Commuters` = commuters ,
             `% Unemployed` = unemployed_persons ,
             `% Insufficient Vehicles` = insufficient_commuter_vehicles ,
             `% Zero Vehicles` = households_without_a_vehicle ,
             `% No Computer Access` = no_computer_access ,
             `% No Broadband Access` = no_broadband_access ,
             `% K-12 Students` = students_k_12 ,
             `% Age 0-21` = youth_0_21 ,
             `% Age 65+` = retirees_65 ,
             `% < 1x Poverty` = people_below_1_0_poverty ,
             `% < 2x Poverty` = people_below_2_0_poverty ,
             `% Food Stamps` = food_stamps_recipients ,
             `% Renters` = renter_households ,
             `% Cost-Burdened Renters` = cost_burdened_renters_35_percent ,
             `% Cost-Burdened Owners` = cost_burdened_owners_with_mortgage_35_percent ,
             `% Overcrowded HH` = overcrowded_households ,
      ) %>%
      mutate(across(c(`% POC`:`% Overcrowded HH`), 
                    ~scales::percent(round(., digits = 3), accuracy = 0.1)),
            across(c(`Adj. HH Income`, `Med. HH Income`), 
                   ~scales::dollar(.)))
  },
  
  # Use autoWidth and scrollX to overflow many columns problem for table modal popup
  # https://stackoverflow.com/questions/34850382/setting-column-width-in-r-shiny-datatable-does-not-work-in-case-of-lots-of-colum
  options = list(pageLength=10, autoWidth = TRUE, scrollX = TRUE))
  
}


# Run the application 
# options(browser = "/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary")
# runApp(list(ui = ui, server = server, display.mode = "showcase"), host = "127.0.0.1", port = 7002, launch.browser = T) # 192.168.1.170 # 127.0.0.1
shinyApp(ui = ui, server = server)
