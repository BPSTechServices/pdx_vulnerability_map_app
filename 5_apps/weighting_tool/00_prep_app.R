## TODO Explore simputation package to impute missing values simply
## https://cran.r-project.org/web/packages/simputation/vignettes/intro.html

library(naniar)
library(simputation)
# setwd("~/projects/repos/vulnerability_weighting_map/")
source("GLOBAL.R")
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}

# file.copy("1_data/3_processed/acs_vuln_weighting_data.rds",
#           to = "5_apps/weighting_tool/",
#           overwrite = TRUE)

wide_data <- readRDS("1_data/3_processed/acs_vuln_weighting_data.rds") %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.5) 

PRIMARY_PLACE %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.3) %>% 
  saveRDS("5_apps/weighting_tool/primary_place_outline.rds")

vis_miss(wide_data)

imputed <- wide_data %>%
  st_drop_geometry() %>%
  impute_lm(median_household_income ~ people_of_color + adults_without_4_yr_degree) %>%
  impute_lm(average_household_size ~ students_k_12 + overcrowded_households) %>%
  mutate(adjusted_household_income = median_household_income / average_household_size ^ 0.5)

final_data <- imputed %>%
  left_join(., wide_data %>% select(GEOID), by = "GEOID") %>%
  st_as_sf()

vis_miss(final_data)

saveRDS(final_data, "5_apps/weighting_tool/acs_vuln_weighting_data.rds")

hatch_vars <- c("people_of_color", "households_with_limited_english", "persons_with_disabilities", "retirees_65", "youth_0_21")

map(hatch_vars, function(hatch_var){
  final_data %>%
    filter(in_primary_place) %>%
    mutate(flag_hatch = ifelse(cume_dist(.data[[hatch_var]]) >= 0.6, TRUE, FALSE)) %>%
    filter(flag_hatch) %>%
    HatchedPolygons::hatched.SpatialPolygons(., density = 400, angle = 45) %>% ## spatial projection matters for density argument
    mutate(col = 1,
           hatch_var = hatch_var) %>%
    saveRDS(paste0("5_apps/weighting_tool/hatch_", hatch_var, ".rds"))
})

vulnerability_results <- final_data %>%
  filter(in_primary_place) %>%
  mutate(across(.cols = c(people_of_color:adjusted_household_income), 
                .fns = list(rnk = ~cume_dist(.),
                            z = ~scale(.))),
         across(ends_with("_z"), ~ case_when(. > 3 ~ 3,
                                             . < -3 ~ -3,
                                             T ~ .)),
         # median_household_income_rnk = 1 - median_household_income_rnk,
         # median_household_income_z = -median_household_income_z,
         adjusted_household_income_rnk = 1 - adjusted_household_income_rnk,
         adjusted_household_income_z = -median_household_income_z,
         # per_capita_income_rnk = 1 - per_capita_income_rnk,
         # per_capita_income_z = -per_capita_income_z,
         
         composite_score = people_of_color_rnk + black_native_american_rnk + 
           adjusted_household_income_rnk + housing_cost_burdened_rnk + 
           adults_without_4_yr_degree_rnk,
         
         indexed_score = round(range01(composite_score, na.rm = T) * 100, 0),
         flag_vulnerable = ifelse(indexed_score >= 60, TRUE, FALSE)) 

vulnerability_results %>%
  filter(flag_vulnerable) %>%
  HatchedPolygons::hatched.SpatialPolygons(., density = 400, angle = 135) %>% ## spatial projection matters for density argument
  mutate(col = 1,
         hatch_var = "vulnerable") %>%
  saveRDS("5_apps/weighting_tool/hatch_vulnerable.rds")


##### Test models - Do this once for each imputed variable ---------------------
## Use a linear model to impute median household income based off race and education
# create model object
# mhi.fit <- lm(median_household_income ~ people_of_color + adults_without_4_yr_degree, 
#               data = wide_data)
# 
# # see model fit... it's a good fit
# summary(mhi.fit)
# 
# avghhsize.fit <- lm(average_household_size ~ students_k_12 + overcrowded_households, 
#                     data = wide_data)
# summary(avghhsize.fit)
