## TODO Explore simputation package to impute missing values simply
## https://cran.r-project.org/web/packages/simputation/vignettes/intro.html

library(naniar)
library(simputation)
# setwd("~/projects/repos/vulnerability_weighting_map/")
source("GLOBAL.R")
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}

# file.copy("1_data/3_processed/acs_vuln_weighting_data.rds",
#           to = "5_apps/weighting_tool/",
#           overwrite = TRUE)

wide_data <- readRDS("1_data/3_processed/acs_vuln_weighting_data.rds") %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.5) 

PRIMARY_PLACE %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.3) %>% 
  saveRDS("5_apps/weighting_tool/primary_place_outline.rds")

vis_miss(wide_data)

imputed <- wide_data %>%
  st_drop_geometry() %>%
  impute_lm(median_household_income ~ people_of_color + adults_without_4_yr_degree) %>%
  impute_lm(average_household_size ~ students_k_12 + overcrowded_households) %>%
  mutate(adjusted_household_income = median_household_income / average_household_size ^ 0.5)

final_data <- imputed %>%
  left_join(., wide_data %>% select(GEOID), by = "GEOID") %>%
  st_as_sf()

vis_miss(final_data)

saveRDS(final_data, "5_apps/weighting_tool/acs_vuln_weighting_data.rds")

## TODO: Run 4_scripts/2_analysis/01_generate_vulnerability_data.R after completing this

##### Test models - Do this once for each imputed variable ---------------------
## Use a linear model to impute median household income based off race and education
# create model object
# mhi.fit <- lm(median_household_income ~ people_of_color + adults_without_4_yr_degree, 
#               data = wide_data)
# 
# # see model fit... it's a good fit
# summary(mhi.fit)
# 
# avghhsize.fit <- lm(average_household_size ~ students_k_12 + overcrowded_households, 
#                     data = wide_data)
# summary(avghhsize.fit)
