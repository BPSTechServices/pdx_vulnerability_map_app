library(shiny)
library(tidyverse)
library(leaflet)
library(DT)

df <- readRDS("changes_2010t2020_vulnerability.rds") %>% 
  filter(variable == "People of color", agg == "percent") %>%
  rmapshaper::ms_simplify(.) %>% st_transform(WEB_EPSG) 
  

ui <- fluidPage(
  leafletOutput("tracts", height = "550px")
  # fluidRow(
  #   column(8, leafletOutput("tracts", height = "550px") ),
  #   column(4, 
  #          span("Select a tract")#, span( style="color:green", "Origin"), span(" and "), 
  #          # span( style="color:red", "Destination"), 
  #          # span(" from the map:"),
  #          # br(),br(),
  #          # htmlOutput("od_info")%>% withSpinner(color="#0dc5c1"),
  #          # hr(),
  #          # htmlOutput("od_total")%>% withSpinner(color="#0dc5c1"),
  #          # hr(),
  #          # htmlOutput("od_total_5")%>% withSpinner(color="#0dc5c1")    
  #   ))
  # ),
  # br(),br(),
  # fluidRow(
  #   column(9, div(DT::dataTableOutput("od_vol"),  width = "100%", style = "font-size:100%"))
  # ),
  # fluidRow(
  #   column(5, plotlyOutput("od_ton_chart", width = "100%", height = "350px")%>% 
  #            withSpinner(color="#0dc5c1")),
  #   column(3, plotlyOutput("od_ton_pie", width = "100%", height = "250px")%>% 
  #            withSpinner(color="#0dc5c1")),
  #   column(3, plotlyOutput("od_ton_pie_5", width = "100%", height = "250px")%>% 
  #            withSpinner(color="#0dc5c1"))
  # ),
  # hr(),
  # fluidRow(
  #   column(5, plotlyOutput("od_value_chart", width = "100%", height = "350px")%>% 
  #            withSpinner(color="#0dc5c1")),
  #   column(3, plotlyOutput("od_value_pie", width = "100%", height = "250px")%>% 
  #            withSpinner(color="#0dc5c1")),
  #   column(3, plotlyOutput("od_value_pie_5", width = "100%", height = "250px")%>% 
  #            withSpinner(color="#0dc5c1"))
  # )  
)

server <- function(input, output, session) {
 
  output$tracts <- renderLeaflet({
    leaflet() %>%
      addProviderTiles('CartoDB.Positron') %>%
      setView(lng = -122.65, lat = 45.52, zoom = 11) #%>% 
      # addLegend("topright", pal = pal,
      #           values = bins,
      #           title = "Vulnerability Index",
      #           opacity = 0.6) %>%
      # 
      
  })
  
  observe({
    proxy <- leafletProxy("tracts", data = df)
    
    proxy %>% clearShapes() %>%
      addPolygons(
        fillColor = "gray",
        weight = 1,
        opacity = 1,
        color = "white",
        dashArray = "3",
        # popup = popup_context,
        fillOpacity = 0.5)
  })
  
}

shinyApp(ui, server)