## Determine weighting methods -------------------------------------------------
## Variables that are population-based should be weighted by population
## Variables that are unit-based should be weighted by households
## Variables that are aggregate may need to be re-weighted???
# c("B25106", "B03002", "B19013", "B25010", "B15002")

## Population-based tables: 
# B03002
# B15002

## Unit-based tables: 
# B25010
# B25106
# B19013

## Extensive
# B03002
# B15002
# B25106

## Intensive (extensive == FALSE)
# B25010
# B19013

prep_interp <- acs_table_query_longitudinal %>%
  separate(., variable, into = c("table", "varnum"),
           sep = "_", remove = F) %>%
  mutate(varnum = as.numeric(varnum),
         extensive = ifelse(table %in% c("B03002", "B15002", "B25106"), TRUE, FALSE),
         weight_column = ifelse(table %in% c("B03002", "B15002"), "POP20", "HOUSING20"),
         group = paste0(extensive, weight_column)) %>%
  left_join(., TRACTS_2010t2020.SF, by = c("GEOID", "year")) %>%
  st_as_sf() 

# prep_interpL <- split(prep_interp, prep_interp$group) %>% 
#   enframe() %>% select(-name) #%>%
# mutate(ext = c(FALSE, TRUE, TRUE),
#        wgt = c("HOUSING20", "HOUSING20", "POP20")) %>%
# select(-name) %>%
# mutate(n = pmap(list(value, ext, wgt),
# .f = interpolate_pw(
#   from = value %>% as.data.frame() %>% filter(year == 2015) %>% select(estimate),
#   to = value %>% as.data.frame() %>% filter(year == 2020),
#   to_id = "GEOID",
#   weights = STATE_BLOCKS.2020,
#   weight_column = wgt,
#   crs = TARGET_EPSG,
#   extensive = ext
#                 )))

# prep_interpL %>%
#   as.list() %>%
#   pmap_dfr(.f = function(data, ext, wgt){
#     df <- data$value
#     interpolate_pw(
#       from = df %>% filter(year == 2015) %>% select(estimate),
#       to = df %>% filter(year == 2020),
#       to_id = "GEOID",
#       weights = STATE_BLOCKS.2020,
#       weight_column = wgt,
#       crs = TARGET_EPSG,
#       extensive = ext
#     )
#   })

ext <- c(FALSE, TRUE, TRUE)
wgt <- c("HOUSING20", "HOUSING20", "POP20")

tmp <- split(prep_interp, prep_interp$group)[[1]] %>%
  split(.$variable)

test <- tmp %>%
  future_map(.f = function(.x){
    wgt <- .x$weight_column[1]
    ext <- .x$extensive[1]
    
    interpolate_pw(
      from = .x %>% filter(year == 2015) %>% select(estimate),
      to = .x %>% filter(year == 2020),
      to_id = "GEOID",
      weights = STATE_BLOCKS.2020,
      weight_column = wgt,
      crs = TARGET_EPSG,
      extensive = ext)
    
  })

tmp$B19013_001$weight_column[1]

crosswalk()

tmp <- pmap(
  .l = list(split(prep_interp, prep_interp$group), ext, wgt),
  .f = function(df, ext, wgt){
    
    df_by_var <- df %>% split(.$variable)
    df_by_var %>%
      map()
    
    interpolate_pw(
      from = df_by_var %>% filter(year == 2015) %>% select(estimate),
      to = df_by_var %>% filter(year == 2020),
      to_id = "GEOID",
      weights = STATE_BLOCKS.2020,
      weight_column = wgt,
      crs = TARGET_EPSG,
      extensive = ext)
  }
)


acs_table_query_longitudinal %>%
  separate(., variable, into = c("table", "varnum"),
           sep = "_", remove = F) %>%
  mutate(varnum = as.numeric(varnum))



# left_join(., TRACTS.2019.SF, by = "GEOID") %>%
#   st_as_sf() %>%
#   filter(agg == "count", year == 2015) %>%
#   split(.$variable) %>%
#   map(~select(.x, estimate))


hhs <- acs_table_query_longitudinal %>%
  group_by(GEOID, year) %>%
  mutate(hh = estimate[variable == "B25106_001"],
         hhsize = estimate[variable == "B25010_001"],
         hhswgt = hhsize * hh) %>%
  distinct(GEOID, year, hh, hhsize, hhswgt) %>% ungroup() 


hhs <- filter(variable == "B25010_001") %>%
  left_join(., TRACTS_2010t2020.SF, by = c("GEOID", "year")) %>%
  st_as_sf() 

new_hhs <- interpolate_pw(
  from = hhs %>% filter(year == 2015) %>% select(estimate),
  to = hhs %>% filter(year == 2020),
  to_id = "GEOID",
  weights = STATE_BLOCKS.2020,
  weight_column = "HOUSING20",
  crs = TARGET_EPSG,
  extensive = FALSE
)

hhs %>% filter(year == 2020) %>% mapview(zcol = "estimate", layer.name = "2020 estimate") +
  new_hhs %>% mapview(zcol = "estimate", layer.name = "2015 allocation") +
  acs_table_query_longitudinal %>%
  filter(variable == "B25010_001", year == 2015) %>%
  left_join(., TRACTS_2010t2020.SF, by = c("GEOID", "year")) %>%
  st_as_sf() %>% mapview(zcol = "estimate", layer.name = "2015 actual")

