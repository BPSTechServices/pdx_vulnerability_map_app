# Must first run 5_apps/weighting_tool/00b_prep_app_interp.R to generate imputed data
library(RColorBrewer)
library(leaflet.extras2)
library(mapview)
library(sf)
library(tidyverse)
library(cowplot)
source("GLOBAL.R")
source("GLOBAL_interpolation_addendum.R")
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}

imputed_data <- readRDS("5_apps/weighting_tool/acs_vuln_weighting_data_imputed.rds")

acs_data_aggregated <- readRDS("1_data/2_interim/acs_data_aggregated_interpolated.rds")

## Generate a vulnerability score based off the desired methodology
vulnerability_results <- imputed_data %>%
  st_drop_geometry() %>%
  filter(in_primary_place) %>%
  group_by(year) %>% 
  mutate(across(.cols = c(people_of_color:average_household_size), 
                .fns = list(rnk = ~cume_dist(.),
                            z = ~scale(.))),
         across(ends_with("_z"), ~ case_when(. > 3 ~ 3,
                                             . < -3 ~ -3,
                                             T ~ .)),
         adjusted_household_income_rnk = 1 - adjusted_household_income_rnk,
         adjusted_household_income_z = -adjusted_household_income_z,
         
         composite_score = people_of_color_rnk + black_native_american_rnk + 
           adjusted_household_income_rnk + housing_cost_burdened_rnk + 
           adults_without_4_yr_degree_rnk,
         
         indexed_score = round(range01(composite_score, na.rm = T) * 100, 0),
         flag_vulnerable = ifelse(indexed_score >= 60, TRUE, FALSE)) 

vulnerability_results %>%
  select(GEOID, year, composite_score, people_of_color_rnk, black_native_american_rnk,
         adjusted_household_income_rnk, housing_cost_burdened_rnk, adults_without_4_yr_degree_rnk) %>%
  mutate(across(ends_with("rnk"),
                .fns = list(contrib = ~ . / composite_score))) %>%
  select(GEOID, year, ends_with("contrib")) %>%
  sample_n(6) %>%
  pivot_longer(-c(GEOID, year), names_to = "metric", values_to = "contribution") %>%
  arrange(GEOID, year, metric) %>%
  filter(year == 2010) %>% #, GEOID == "41051000101") %>%
  ggplot(aes(x="", y=contribution, fill=metric)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +
  facet_wrap(~GEOID)


## Calculate changes -----------------------------------------------------------

ahi <- acs_data_aggregated %>%
  filter(agg %in% c("percent", "aggregate", "median")) %>%
  pivot_wider(id_cols = c(GEOID, year), names_from = variable, values_from = estimate) %>% 
  janitor::clean_names() %>% rename(GEOID = geoid) %>%
  group_by(year) %>%
  simputation::impute_lm(median_household_income ~ people_of_color + adults_without_4_yr_degree) %>%
  simputation::impute_lm(average_household_size ~ people_of_color + adults_without_4_yr_degree) %>%
  mutate(adjusted_household_income = median_household_income / average_household_size ^ 0.5) %>%
  pivot_longer(cols = -c(GEOID, year), names_to = "variable", values_to = "E") %>%
  filter(variable == "adjusted_household_income") %>%
  mutate(variable = "Adjusted household income") %>%
  mutate(agg = "median")


vulnerability_data <- vulnerability_results %>%
  ungroup() %>%
  mutate(agg = "aggregate",
         variable = "Vulnerability score") %>%
  select(GEOID, year, agg, variable, E = indexed_score) %>%
  pivot_wider(id_cols = c(GEOID, agg, variable), 
              names_from = c(year), 
              values_from = E) %>%
  rename(est_2010 = `2010`, est_2015 = `2015`, est_2020 = `2020`)

vulnerability_data <- vulnerability_data %>%
  mutate(across(c(est_2010:est_2020), .fns = ~ifelse(. >= 60, TRUE, FALSE))) %>%
  mutate(agg = "flag") %>%
  rbind(., vulnerability_data)


## Calculate changes between years
changes <- acs_data_aggregated %>%
  select(GEOID, year, variable, E = estimate, agg) %>%
  rbind(., ahi) %>%
  pivot_wider(id_cols = c(GEOID, agg, variable), names_from = c(year), values_from = E) %>%
  rename(est_2010 = `2010`, est_2015 = `2015`, est_2020 = `2020`) %>%
  rbind(., vulnerability_data) %>%
  mutate(abs_change_10t20 = est_2020 - est_2010,
         pct_change_10t20 = abs_change_10t20 / est_2010,
         abs_change_15t20 = est_2020 - est_2015,
         pct_change_15t20 = abs_change_15t20 / est_2015) %>%
  ungroup() %>%
  group_by(agg, variable) %>%
  mutate(across(c(est_2010:pct_change_15t20),
                .fns = list(z = ~(. - mean(., na.rm=TRUE)) / sd(., na.rm=TRUE)))) %>%
  ungroup() %>% 
  left_join(., select(TRACTS_HIRES.SF, GEOID), by = "GEOID") %>%
  st_as_sf() %>% st_transform(TARGET_EPSG) 

saveRDS(changes, "1_data/2_interim/changes_2010t2020_vulnerability.rds")

rio::export(st_drop_geometry(changes), "1_data/2_interim/changes_2010t2020_vulnerability.xlsx")

changes %>%
  ungroup() %>%
  group_by(agg, variable) %>%
  mutate(across(c(est_2010:pct_change_15t20),
                .fns = list(z = ~base::scale(.))))



## Memo figures ----------------------------------------------------------------

chg10t20 <- changes %>%
  filter(agg == "flag",
         variable == "Vulnerability score") %>%
  mutate(across(c(abs_change_10t20, abs_change_15t20),
                .fns = list(desc = ~ case_when(
                  . == -1 ~ "No longer vulnerable",
                  . == 0 ~ "No change",
                  . == 1 ~ "Newly vulnerable"))),
         across(ends_with("_desc"),
                .fns = ~ factor(., levels = c(
                  "No longer vulnerable", "No change", "Newly vulnerable")
                  ))) %>% #View()
mapview(zcol = "abs_change_10t20_desc", layer.name = "Change in vulnerability 2010 to 2020",
        map.types = "CartoDB.Positron",
        col.region = RColorBrewer::brewer.pal(3, "PiYG")) ; chg10t20#BrBG PiYG PRGn PuOr RdBu RdGy RdYlBu RdYlGn Spectral

mapshot(chg10t20, file = "1_data/3_processed/change_vulnerability_score_2010t2020.png", 
        remove_controls = c("zoomControl", "layersControl", "homeButton","drawToolbar", "easyButton", "control"))


changes %>%
  filter(agg == "aggregate",
         variable == "Vulnerability score") %>%
  mapview(zcol = "abs_change_10t20")#, layer.name = "Change in vulnerability 2015 to 2020",
          # col.region = RColorBrewer::brewer.pal(3, "PiYG")) #BrBG PiYG PRGn PuOr RdBu RdGy RdYlBu RdYlGn Spectral


vscore10 <- changes %>%
  filter(agg == "aggregate",
         variable == "Vulnerability score") %>%
  mapview(zcol = "est_2010", col.region = viridis::plasma(6),
          alpha.region = 0.55, color = "white", lwd = 1.4,
          layer.name = "2010 Vulnerability Score",
          at = c(0, 20, 40, 60, 80, 100)) ; vscore10

mapshot(vscore10, file = "1_data/3_processed/vulnerability_score_2010.png", 
        remove_controls = c("zoomControl", "layersControl", "homeButton","drawToolbar", "easyButton", "control"))

vscore15 <- changes %>%
  filter(agg == "aggregate",
         variable == "Vulnerability score") %>%
  mapview(zcol = "est_2015", col.region = viridis::plasma(6),
          alpha.region = 0.55, color = "white", lwd = 1.4,
          layer.name = "2015 Vulnerability Score",
          at = c(0, 20, 40, 60, 80, 100)) ; vscore15

mapshot(vscore15, file = "1_data/3_processed/vulnerability_score_2015.png", 
        remove_controls = c("zoomControl", "layersControl", "homeButton","drawToolbar", "easyButton", "control"))

vscore20 <- changes %>%
  filter(agg == "aggregate",
         variable == "Vulnerability score") %>%
  mapview(zcol = "est_2020", col.region = viridis::plasma(6),
          alpha.region = 0.55, color = "white", lwd = 1.4,
          layer.name = "2020 Vulnerability Score",
          at = c(0, 20, 40, 60, 80, 100)) ; vscore20

mapshot(vscore20, file = "1_data/3_processed/vulnerability_score_2020.png", 
        remove_controls = c("zoomControl", "layersControl", "homeButton","drawToolbar", "easyButton", "control"))


m3 <- changes %>%
  filter(agg == "count",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "People of color") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Abs Change in # People of Color 2010-2020",
          col.region = RColorBrewer::brewer.pal(100, "PuOr"), 
          at = c(-1000, -500, 0, 500, 1000, 1500, 2000, 2500))


m4 <- changes %>%
  filter(agg == "count",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "People of color") %>%
  mapview(zcol = "pct_change_10t20", layer.name = "Pct Change in # People of Color 2010-2020",
          col.region = RColorBrewer::brewer.pal(8, "PuOr"), 
          at = c(-0.55, -0.2, 0, .2, .4, .6, 7)
          )

m5 <- changes %>%
  filter(agg == "percent",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "People of color") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Pct Point Change in % People of Color 2010-2020",
          col.region = RColorBrewer::brewer.pal(8, "PuOr"), 
          at = c(-0.25, -0.12, 0, .12, .25, .33)
  )

# Use pipe to do side-by-side map thanks to leaflet.extras2
m3 | m4

changes %>%
  filter(agg == "count",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Housing cost burdened") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Abs Change in # Cost-Burdened Households 2010-2020",
          col.region = RColorBrewer::brewer.pal(5, "BrBG"), 
          at = c(-500, -250, 0, 250, 500)
          )


changes %>%
  filter(agg == "percent",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Housing cost burdened") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Pct Change in # Cost-Burdened Households 2010-2020",
          col.region = RColorBrewer::brewer.pal(5, "BrBG"), 
          at = c(-0.33, -0.15, 0, 0.1, 0.2)
  )


changes %>%
  filter(agg == "median",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Adjusted household income") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Abs Change in Adjusted HH Income 2010-2020",
          col.region = RColorBrewer::brewer.pal(5, "RdYlGn"), 
          at = c(-15000, -7000, 0, 7000, 15000, 30000, 46000)
  )

changes %>%
  filter(agg == "median",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Median household income") %>%
  mapview(zcol = "pct_change_10t20", layer.name = "Pct Change in Adjusted HH Income 2010-2020",
          col.region = RColorBrewer::brewer.pal(10, "RdYlGn"), 
          at = c(-0.36, -0.2, -0.1, 0, 0.15, 0.30, 0.45, 0.6, 1.7)
  )


changes %>%
  filter(agg == "aggregate",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Average household size") %>%
  mapview(zcol = "pct_change_10t20", layer.name = "Pct Change in Avg HH Size 2010-2020",
          col.region = RColorBrewer::brewer.pal(10, "RdYlGn"), 
          at = c(-Inf, -0.1, 0, 0.1, Inf)
  )

changes %>%
  filter(agg == "aggregate",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Average household size") %>%
  mapview(zcol = "abs_change_10t20", layer.name = "Abs Change in Avg HH Size 2010-2020",
          col.region = RColorBrewer::brewer.pal(10, "RdYlGn"), 
          at = c(-Inf, -0.2 -0.1, 0, 0.1, 0.2, Inf)
  )

changes %>%
  filter(agg == "aggregate",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Average household size") %>%
  mapview(zcol = "pct_change_10t20_z", layer.name = "Change in Avg HH Size 2010-2020 (Z-Score)",
          col.region = RColorBrewer::brewer.pal(7, "RdBu"), 
          at = c(-Inf, -2, -1, 0, 1, 2, 3, Inf)
  )

changes %>%
  filter(agg == "median",
         GEOID %in% TRACTS_IN_PLACE,
         # abs_change_10t20 < 0,
         variable == "Median household income") %>%
  mapview(zcol = "pct_change_10t20_z", layer.name = "Change in Adj HH Inc 2010-2020 (Z-Score)",
          col.region = RColorBrewer::brewer.pal(7, "RdBu"), 
          at = c(-Inf, -2, -1, 0, 1, 2, 3, Inf)
  )


get_decennial(geography = "block", table = "H11I", year = 2010, state = "OR", county = "Multnomah")

library(cowplot)

generate_plot(changes, c("41051003302"))

generate_plot(changes, c("41051003603")) 

generate_plot(changes, c("41051004200")) 

generate_plot(changes, c("41051003301"))

generate_plot(changes, c("41051001702")) # 41051001702 # 41051002903

generate_plot <- function(df, TRACTS_TO_GRAPH){
  
  df_abs <- df %>%
    filter(GEOID %in% TRACTS_TO_GRAPH,
           agg != "percent")
  
  df_pct <- df %>%
    filter(GEOID %in% TRACTS_TO_GRAPH,
           agg == "percent")
  
  p1 <- df_abs %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           !(variable %in% c(
             "Adjusted household income", "Average household size", "Median household income"))
    ) %>%
    ggplot(aes(x = abs_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::comma_format(accuracy = 1))
  
  p1b <- df_pct %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           !(variable %in% c(
             "Adjusted household income", "Average household size", "Median household income"))
    ) %>%
    ggplot(aes(x = abs_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::comma_format(accuracy = 1))
  
  p2 <- df_abs %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           !(variable %in% c(
             "Adjusted household income", "Average household size", "Median household income"))
    ) %>%
    ggplot(aes(x = pct_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::percent_format(accuracy = 1))
  
  p2b <- df_pct %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           !(variable %in% c(
             "Adjusted household income", "Average household size", "Median household income"))
    ) %>%
    ggplot(aes(x = pct_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::comma_format(accuracy = 1))
  
  p3 <- df_abs %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           variable %in% c( "Adjusted household income")) %>%
    ggplot(aes(x = abs_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::dollar_format(accuracy = 1, scale = 1/1000, suffix = "K"))
  
  p3b <- df_pct %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           variable %in% c( "Adjusted household income")) %>%
    ggplot(aes(x = abs_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::dollar_format(accuracy = 1, scale = 1/1000, suffix = "K"))
  
  p4 <- df_abs %>% 
    filter(GEOID %in% TRACTS_TO_GRAPH,
           variable %in% c("Adjusted household income")) %>%
    ggplot(aes(x = pct_change_10t20, y = variable)) +
    geom_col() + theme_minimal() + labs(x = "", y = "") +
    geom_vline(xintercept = 0) +
    scale_x_continuous(labels = scales::percent_format(accuracy = 1))
  
  plot_grid(p1, p2, p3, p4,
            labels = c('Absolute', 'Percentage', '', ''), 
            label_size = 12,
            rel_heights = c(8,3)) 
}

generate_plot(changes, c("41051001702"))

interstate_corridor <- c("41051003801", "41051003802", "41051003803", "41051003501", 
                     "41051003502", "41051003701", "41051003702", "41051003401",
                     "41051003502", "41051003402", "41051002203", "41051002303")

stjblocks <- STATE_BLOCKS.2020 %>%
  mutate(tractid = substr(GEOID20,1,11) ) %>%
  filter(tractid  %in% c("41051004104", "41051004103", "41051004200", "41051004102"))
  


# mapview(stjblocks, lwd = 0.8, alpha.region = 0.2, zcol = "tractid", layer.name = "Blocks by Tract") +
  mapview(st_point_on_surface(stjblocks), cex = 1.5, zcol = "tractid", lwd = 0,
          layer.name = "Block Centroids") +
  mapview(filter(TRACTS_2010t2020.SF, year == 2010, GEOID %in% c("41051004101", "41051004102", "41051004200", c("41051004104", "41051004103", "41051004200", "41051004102"))),
          layer.name = "2010 Tracts", alpha.region = 0, col.region = "white", color = "black")
  

# st_write(vulnerability_data, dsn = "1_data/3_processed/2020_vulnerability_data_portland.geojson")
# vulnerability_data %>%
#   st_drop_geometry() %>% rio::export("1_data/3_processed/2020_vulnerability_data_portland.xlsx")
