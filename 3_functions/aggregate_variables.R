## Take a "long-format" ACS table, aggregate (sum) across multiple variables,
## and append a percentage based on an input summary variable
aggregate_variables <- function(long_acs_data, agg_table, varnums, 
                                summary_var = NULL, 
                                varname = "new_var"){
  
  ## If two or more summary variables are specified, re-create the summary
  ## variable by aggregating those variables and r-binding to the data
  if(length(summary_var >1)){
    summarized_summary_var <- long_acs_data %>%
      filter(variable %in% summary_var) %>%
      group_by(GEOID) %>%
      summarize(estimate = sum(estimate, na.rm = T),
                moe = moe_sum(moe, estimate, na.rm = T)) %>%
      ungroup() %>%
      mutate(variable = "summary_var",
             agg = "count")
    
    summary_var <- "summary_var"
    
    long_acs_data <- long_acs_data %>%
      rbind(., summarized_summary_var)
  }
  
  # Separate into a table and variable number field
  df <- long_acs_data %>%
    separate(., variable, into = c("table", "varnum"),
             sep = "_", remove = F) %>%
    mutate(varnum = as.numeric(varnum))
  
  # Create a summary variable temporary df
  df_sumvar <- df %>%
    filter(variable == summary_var) %>%
    select(GEOID, summary_est = estimate, summary_moe = moe)
  
  # Aggregate the user-provided table
  df_counts <- df %>%
    filter(table == agg_table, varnum %in% varnums) %>%
    arrange(GEOID) %>%
    group_by(GEOID, agg) %>%
    summarize(variable = varname,
              estimate = sum(estimate, na.rm = T),
              moe = moe_sum(moe, estimate, na.rm = T)) %>%
    ungroup() 
  
  ## TODO Make function return df_counts if no summary variable is passed
  # if(is.null(summary_var)){
  #   return(df_counts)
  # }
  
  # Join summary variable, calculate percents, and rbind to count data
    df_counts %>%
      left_join(., df_sumvar, by = "GEOID") %>%
      group_by(GEOID) %>%
      summarize(variable = varname,
                pct = estimate / summary_est,
                pct_moe = moe_prop(estimate, summary_est, moe, summary_moe),
                agg = "percent") %>%
      rename(estimate = pct, moe = pct_moe) %>%
      rbind(., df_counts) %>%
      mutate(table = agg_table, varnum = NA_real_)
}

# aggregate_variables(acs_table_query,
#                     agg_table = "B25014",
#                     varnums = c(5,6,7,11,12,13),
#                     summary_var = "B25014_001",
#                     varname = "Overcrowded HH")

## With multiple summary variables
# insuff_veh <- aggregate_variables(
#   acs_table_query, agg_table = "B08203", varnums = c(14,20,21,26,27,28),
#   summary_var = c("B08203_013", "B08203_019", "B08203_025"), 
#   varname = "Insufficient commuter vehicles")
