## This script queries American Community Survey data for a user-defined metro area and
## produces a table with pre-selected vulnerability indicators. You can change the metro
## area to your own community to download the data and export it for use in the shiny app.
## This script assumes you will download regional data and also a "core" city for that 
## region. Make sure you adjust the `primary_place` variable if you seek an alternate city
## within a region.

## Source script that loads libraries, functions and data
source("global.R")

##### 01. Determine and input target region's FIPS/CBSA codes and places #####

## TODO: Enter a region to look up in the line below to search for the correct CBSA FIPS 
"atlanta" -> REGION_OF_INTEREST ; county2msa %>% 
  filter(str_detect(cbsaname15, regex(REGION_OF_INTEREST, ignore_case = TRUE)))

## TODO: Enter the correct CBSA FIPS code found from lookup above to determine the counties that are part of that CBSA
counties2download <- get_counties_from_cbsa(12060)

## Determine states from counties
states2download <- get_states_from_stcnty_fips(counties2download)

## Main places in CBSA
places_in_cbsa <- tigris::places(states2download) %>%
  st_filter(., filter(tigris::counties(state = states2download, cb = T), GEOID %in% counties2download)) %>%
  st_transform(crs = '+proj=longlat +datum=WGS84') %>%
  arrange(desc(ALAND)) %>%
  head() 

## Grab GEOID/FIPS code of the primary place of interest, which is USUALLY the largest
## by land area. 
primary_place <-  places_in_cbsa[1,]


##### 02. Download data using tidycensus #####
## View potential variables available to use
acs19 <- load_variables(2019, "acs5", cache = TRUE)
s19 <- load_variables(2019, "acs5/subject", cache = TRUE)

## Query for total population
query1 <- get_acs(geography = "tract", 
                  state = states2download, 
                  table = "B01001", 
                  year = 2019, 
                  output = "wide")

## Query for key demographics 
## TODO Add in additional ACS demographic variables to weight here
query2 <- get_acs(geography = "tract", 
                  state = states2download, 
                  year = 2019, 
                  output = "wide",
                  variables = c("median_hh_inc" = "B19013_001", "tot_hh" = "B25003_001", 
                                "tot_renters" = "B25003_003", "tot_pop" = "B03002_001",
                                "tot_whitenh" = "B03002_003", "tot_black" = "B03002_004", 
                                "tot_aian" = "B03002_005", "tot_asian" = "B03002_006",
                                "tot_nhpi" = "B03002_007", "tot_other" = "B03002_008", 
                                "tot_multi" = "B03002_009", "tot_hisp" = "B03002_012",
                                "univ_food_stamps" = "B19058_001", "tot_food_stamps" = "B19058_002",
                                "univ_devices" = "B28001_001", "tot_no_device" = "B28001_011",
                                "B18101_001", "B18101_003", "B18101_006", "B18101_009") )

## Query for educational attainment
query3 <- get_acs(geography = "tract", 
                  state = states2download, 
                  table = "B15002", 
                  year = 2019, 
                  output = "wide", 
                  geometry = T)

## Join all queries together and recode variables
acs_data <- left_join(query1, query2, by = c("GEOID", "NAME")) %>%
  left_join(., query3, by = c("GEOID", "NAME")) %>%
  mutate(median_hh_inc = median_hh_incE,
         tot_hh = tot_hhE,
         tot_renters = tot_rentersE,
         tot_pop = tot_popE,
         tot_whitenh = tot_whitenhE,
         tot_black = tot_blackE,
         tot_aian = tot_aianE,
         tot_asian = tot_asianE,
         tot_nhpi = tot_nhpiE,
         tot_other = tot_otherE,
         tot_multi = tot_multiE,
         tot_hisp = tot_hispE,
         univ_food_stamps = univ_food_stampsE,
         tot_food_stamps = tot_food_stampsE,
         univ_devices = univ_devicesE,
         tot_no_device = tot_no_deviceE,
         
         tot_age_70_to_79 = B01001_022E + B01001_023E + B01001_046E + B01001_047E,
         tot_age_over_80 = B01001_024E + B01001_025E + B01001_048E + B01001_049E,
         tot_age_over_70 = tot_age_70_to_79 + tot_age_over_80,
         
         tot_adults = B15002_001E,
         tot_ba = B15002_015E + B15002_016E + B15002_017E + B15002_018E +
           B15002_032E + B15002_033E + B15002_034E + B15002_035E,
         tot_noba = tot_adults - tot_ba,
         tot_poc = tot_pop - tot_whitenh,
         
         pct_over_70 = tot_age_over_70 / tot_pop,
         pct_rent = tot_renters / tot_hh,
         pct_ba = tot_ba / tot_adults,
         pct_noba = tot_noba / tot_adults,
         pct_poc = tot_poc / tot_pop,
         pct_underserved_poc = (tot_black + tot_hisp + tot_aian + tot_nhpi) / tot_pop,
         
         pct_food_stamps = tot_food_stamps / univ_food_stamps,
         
         pct_no_device = tot_no_device / univ_devices,
         
         state = substr(GEOID, 1, 2)) %>%
  select(GEOID, NAME, state, NAME, median_hh_inc, tot_hh:tot_hisp, tot_poc, tot_adults, tot_ba, 
         tot_noba, tot_age_over_70, tot_food_stamps, pct_rent, pct_poc, pct_ba, pct_noba, 
         pct_over_70, pct_underserved_poc, pct_food_stamps, pct_no_device, geometry) %>%
  filter(substr(GEOID, 1, 5) %in% counties2download) %>% ## Filter for those tracts in the region
  st_as_sf() %>% st_transform(crs = '+proj=longlat +datum=WGS84')

## Identify a list of tracts that are within the primary place of interest
## Adjust negative distance buffer to fit desired tolerance
tracts_in_place <- acs_data %>%
  st_filter(., st_buffer(primary_place, dist = -0.005)) %>%
  pull(GEOID)

## Create new variable on whether that tract is in the primary place of interest
acs_data <- acs_data %>%
  mutate(in_primary_place = GEOID %in% tracts_in_place)

##### 03. Export data #####
saveRDS(acs_data, "acs_vuln_weighting_data.rds")

## Optionally view map
# mapview::mapview(acs_data, zcol = "in_primary_place") +
#   mapview::mapview(primary_place)
