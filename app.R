##### Begin app ####
## Load functions and data
source("global.R")

##### Begin UI #####

ui <- navbarPage(
  theme = shinytheme("yeti"), ##(lumen, paper, simplex, flatly, yeti) ## See interactive themes: https://gallery.shinyapps.io/117-shinythemes/
  "Vulnerability Weighting",
  
  tabPanel("Vulnerability", value = "vulnerability", 
           sidebarPanel(
             radioButtons(inputId = "geo_filter", label = "Filter Region or Primary Place", choices = c("Region" = "Region", "Primary Place" = "Primary Place"), selected = "Region"),
             sliderInput("wt_poc", "People of color weight", min = 0, max = 5, value = 3),
             sliderInput("wt_poc2", "Black, Indigenous, Latinx weight", min = 0, max = 5, value = 0), 
             sliderInput("wt_inc", "Income weight", min = 0, max = 5, value = 3),
             sliderInput("wt_edu", "Education weight", min = 0, max = 5, value = 3),
             sliderInput("wt_rent", "Renter weight", min = 0, max = 5, value = 3),
             sliderInput("wt_age", "Elderly weight", min = 0, max = 5, value = 0),
             sliderInput("wt_food", "Food stamps weight", min = 0, max = 5, value = 0),
             sliderInput("wt_device", "Computer access weight", min = 0, max = 5, value = 0),
             downloadButton("download_shp", label = "Download SHP"),
             downloadButton("download_geojson", label = "Download GEOJSON")
           ),
           mainPanel(
             tabsetPanel(
               tabPanel("Weighting Tool", id = "tv_map1", tags$style(type = "text/css", "#vulnerabilitymap {height: calc(95vh - 90px) !important;}"), leafletOutput("vulnerabilitymap")), # https://stackoverflow.com/questions/36469631/how-to-get-leaflet-for-r-use-100-of-shiny-dashboard-height/36471739#36471739
               tabPanel("Table", id = "tv_table2", DT::dataTableOutput('composite_vulnerability_table'))
             )
           ))
)


##### Begin server #####
server <- function(input, output, session) {
  
  ##########Vulnerability Mapping ##########
  
  reweighted <- reactive({
    if (input$geo_filter == "Primary Place"){
      vulnerability_data <- vulnerability_data %>%
        filter(in_primary_place == TRUE)
    }
    
    vulnerability_data %>%
      mutate(weighted_edu = ntile(pct_noba, 100) * input$wt_edu,
             weighted_rent = ntile(pct_rent, 100) * input$wt_rent,
             weighted_poc = ntile(pct_poc, 100) * input$wt_poc,
             weighted_inc = ntile(-median_hh_inc, 100) * input$wt_inc,
             weighted_age = ntile(pct_over_70, 100) * input$wt_age,
             weighted_poc2 = ntile(pct_underserved_poc, 100) * input$wt_poc2,
             weighted_food = ntile(pct_food_stamps, 100) * input$wt_food,
             weighted_device = ntile(pct_no_device, 100) * input$wt_device,
             composite_vulnerability = weighted_edu + weighted_rent + weighted_poc + weighted_inc + weighted_age + weighted_poc2 + weighted_food + weighted_device,
             indexed_vulnerability = range01(composite_vulnerability, na.rm = T) * 100) %>%
      arrange(desc(indexed_vulnerability))
  })
  
  # observeEvent(input$download_shp, {
  #   downloadHandler(
  #       filename = function() {
  #         paste('data-', Sys.Date(), '.shp', sep='')
  #       },
  #       content = function(con) {
  #         sf::st_write(obj = data, dsn = con)
  #       }
  #     )
  # })
  
  # output$download_shp<-downloadHandler(
  #   filename = function() {paste('export-', Sys.Date(), '.zip', sep='')},
  #   content = function(file) {
  #     sf::st_write(obj = reweighted(), dsn="shpExport.shp")
    #   zip(zipfile='shpExport.zip', files=Sys.glob("shpExport.*"))
    #   file.copy("shpExport.zip", file)
    #   if (length(Sys.glob("shpExport.*"))>0){
    #     file.remove(Sys.glob("shpExport.*"))
    #   }
    # }
  # )
  
  
  output$download_geojson <- downloadHandler(
    filename = "custom_weight_export-geojson.geojson",
    content = function(file) {
        sf::st_write(obj = reweighted(), dsn = file)
      }
  )  
  
  output$download_shp <- downloadHandler(
    filename = "custom_weight_export-shp.zip",
    content = function(file) {
      sf::st_write(obj = reweighted(), dsn = "custom_weight_export-shp.shp")
      zip(zipfile='custom_weight_export-shp.zip', files=Sys.glob("custom_weight_export-shp.*"))
      file.copy("custom_weight_export-shp.zip", file)
    }
  )  
  
  
  output$vulnerabilitymap <- renderLeaflet({
    
    bins <- c(0, 20, 40, 60, 80, 100)
    pal <- leaflet::colorBin(viridis_pal(option = "C")(length(bins)), domain = reweighted()$indexed_vulnerability, bins = bins)
    popup <- paste0("<strong>Tract: </strong>", reweighted()$NAME, 
                    "<br/>",
                    "<strong>Indexed vulnerability: </strong>", 
                    as.character(round(reweighted()$indexed_vulnerability,0)))
    
    leaflet(reweighted()) %>%
      addProviderTiles('CartoDB.Positron') %>%
      addPolygons(fillColor = ~pal(indexed_vulnerability),
                  weight = 1,
                  opacity = 1,
                  color = "white",
                  dashArray = "3",
                  fillOpacity = 0.7,
                  popup = popup) %>%
      # setView(lng = -97.743, lat = 30.267, zoom = 11) %>% ## Optionally set map center and zoom level
      addLegend("topright", pal = pal,
                values = ~indexed_vulnerability,
                title = "Indexed Vulnerability Score",
                opacity = 0.6)
  })
  
  output$composite_vulnerability_table <- DT::renderDataTable(
    reweighted() %>% 
      select(GEOID, NAME, indexed_vulnerability, in_primary_place) %>%
      st_set_geometry(NULL) %>%
      mutate(indexed_vulnerability = round(indexed_vulnerability, 0)) %>%
      rename(`Indexed Score` = indexed_vulnerability, 
             Name = NAME),
    filter = "top",
    options = list(
      pageLength = 10
    ))
}



# Run the application 
# options(browser = "/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary")
# runApp(list(ui = ui, server = server, display.mode = "showcase"), host = "127.0.0.1", port = 7002, launch.browser = T) # 192.168.1.170 # 127.0.0.1
shinyApp(ui = ui, server = server)

